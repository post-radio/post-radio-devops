---
- hosts: webserver
  become: yes
  vars_files:
    - vars.yml

  tasks:
    - name: Purge dotnet-sdk-7.0
      apt:
        name: dotnet-sdk-7.0
        state: absent

    - name: Remove Microsoft package repository and update
      block:
        - name: Remove microsoft-prod.list
          file:
            path: /etc/apt/sources.list.d/microsoft-prod.list
            state: absent
        - name: Update apt cache
          apt:
            update_cache: yes

    - name: Install dotnet7
      apt:
        name: dotnet7
        state: present

    - name: Check dotnet info
      command: dotnet --info
      register: dotnet_info
      changed_when: false

    - debug: 
        var: dotnet_info.stdout_lines
    - name: Install required packages
      apt:
        name:
          - nginx
          - certbot
          - python3-certbot-nginx
          - git
          - apt-transport-https
          - wget
          - snapd
        state: present

    - name: Copy nginx configuration
      template:
        src: nginx.default.conf.j2
        dest: /etc/nginx/sites-enabled/default
      notify:
        - Restart nginx

    - name: Check if SSL certificate exists
      stat:
        path: /etc/letsencrypt/live/{{ domain_name }}/fullchain.pem
      register: cert_stat

    - name: Obtain a certificate using the Nginx plugin
      command:
        cmd: certbot --nginx -d {{ domain_name }} -d {{ domain_alias }} --non-interactive --agree-tos --email {{ admin_email }}
        creates: "/etc/letsencrypt/live/{{ domain_name }}/fullchain.pem"
      when: not cert_stat.stat.exists
      notify:
        - Restart nginx

    - name: Check if Microsoft package repository is already added
      stat:
        path: /etc/apt/sources.list.d/microsoft-prod.list
      register: ms_repo_file

    - name: Add Microsoft package repository and install dotnet SDK
      block:
        - name: Download Microsoft package
          get_url:
            url: https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb
            dest: /tmp/packages-microsoft-prod.deb

        - name: Install Microsoft package
          apt:
            deb: /tmp/packages-microsoft-prod.deb

        - name: Install dotnet-sdk using Snap
          shell: sudo snap install dotnet-sdk --classic
          become: yes

        - name: Create symbolic link for dotnet
          command:
            cmd: ln -s /snap/dotnet-sdk/current/dotnet /usr/bin/dotnet
            creates: /usr/bin/dotnet

      when: not ms_repo_file.stat.exists

    - name: Clone project repository
      git:
        repo: "{{ git_repository }}"
        dest: "{{ project_directory }}"
        version: main

    - name: Restore and build the project
      command:
        cmd: dotnet build --configuration Release
        chdir: "{{ project_directory }}"

    - name: Kill all tmux sessions
      shell: tmux list-sessions -F '#S' | xargs -r tmux kill-session -t
      ignore_errors: yes

    - name: Start app in tmux
      shell: |
        tmux new-session -d -s mysession
        tmux send-keys -t mysession 'dotnet run --configuration Release' C-m
      args:
        chdir: "{{ project_directory }}"

  handlers:
    - name: Restart nginx
      service:
        name: nginx
        state: restarted
